<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>日経225スマートAI分析</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  
  <!-- Lightweight Charts -->
  <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
  <!-- marked -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- Custom CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  
  <!-- Custom JS -->
  <script src="{{ url_for('static', filename='script.js') }}" defer></script>
</head>

<body class="bg-light">

  <!-- 🏆 ヘッダー -->
  <header class="mb-4" style="background: linear-gradient(135deg, #1a237e 0%, #283593 100%); color: white; padding: 20px 20px; text-align: center; border-bottom: 4px solid #ffd700; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
      <h1 style="margin: 0; font-size: 24px; letter-spacing: 2px; font-weight: 700; text-shadow: 1px 1px 3px rgba(0,0,0,0.3);">
        <i class="bi bi-graph-up-arrow" style="margin-right: 10px; color: #ffd700;"></i>日経225スマートAI分析
      </h1>
      <p style="margin: 5px 0 0; font-size: 13px; opacity: 0.9; font-weight: 300; letter-spacing: 1px;">Advanced AI All-round Analysis</p>
  </header>

  <div class="container-fluid px-2" style="max-width: 98%;">
    <div class="row g-4">
      
      <!-- 🛠️ 左カラム：コントロール & チャート -->
      <div class="col-lg-12">
        <div class="row g-4">
          <!-- コントロールパネル -->
          <div class="col-md-4 col-lg-3">
            <div class="card h-100 shadow-sm">
              <div class="card-header bg-white">
                <i class="bi bi-sliders me-1"></i> 銘柄選択
              </div>
              <div class="card-body">
                <div class="mb-3 position-relative">
                  <label for="stockSearch" class="form-label fw-bold">銘柄検索</label>
                  <div class="input-group">
                      <span class="input-group-text bg-light"><i class="bi bi-search text-secondary"></i></span>
                      <input type="text" id="stockSearch" class="form-control" placeholder="銘柄名・コードを入力..." autocomplete="off">
                  </div>
                  <div id="searchResults" class="list-group position-absolute w-100 shadow-lg" style="z-index: 1000; max-height: 300px; overflow-y: auto; display: none; top: 100%;">
                      <!-- 検索候補がここに表示されます -->
                  </div>
                </div>

                <div class="mb-3">
                  <label for="industrySelect" class="form-label fw-bold">業種</label>
                  <select id="industrySelect" class="form-select">
                    <option value="all">すべての業種</option>
                    {% for industry in industries %}
                      <option value="{{ industry }}">{{ industry }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="mb-3">
                  <label for="stockSelect" class="form-label fw-bold">銘柄リスト</label>
                  <select id="stockSelect" class="form-select">
                    <option value="">銘柄を選択してください</option>
                  </select>
                </div>

                <div id="recentContainer" class="mt-4">
                  <label class="form-label small text-muted">最近見た銘柄</label>
                  <div id="recentList" class="d-flex flex-wrap gap-2">
                    <!-- JSでボタンが自動生成される -->
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- チャートエリア -->
          <div class="col-md-8 col-lg-9">
            <div class="card shadow-sm mb-3">
              <div class="card-header bg-white d-flex justify-content-between align-items-center py-2">
                <div class="d-flex align-items-center gap-2">
                  <div class="d-flex align-items-center me-2">
                    <i class="bi bi-activity me-1"></i> チャート
                    <button id="resetChartBtn" class="btn btn-sm btn-outline-secondary ms-2 py-0 px-2" title="チャートのスケールをリセット" style="font-size: 0.8rem;">
                      🔄️
                    </button>
                  </div>
                  <!-- サブチャート表示切り替え -->
                  <div class="btn-group btn-group-sm" role="group" aria-label="サブチャート切り替え">
                    <input type="radio" class="btn-check" name="subChartToggle" id="toggleKairi" autocomplete="off" checked>
                    <label class="btn btn-outline-primary py-0" for="toggleKairi" style="font-size: 0.75rem;">乖離率</label>
                    <input type="radio" class="btn-check" name="subChartToggle" id="toggleVol" autocomplete="off">
                    <label class="btn btn-outline-primary py-0" for="toggleVol" style="font-size: 0.75rem;">出来高</label>
                  </div>
                </div>
                <!-- マウスカーソル位置の株価詳細（OHLC） -->
                <div id="ohlc-display" class="small font-monospace text-muted">
                  日付: -- 始値: -- 高値: -- 安値: -- 終値: --
                </div>
              </div>
              <div class="card-body p-2">
                <div id="chart" style="height: 400px; width: 100%;"></div>
                <div id="kairiChart" style="height: 150px; width: 100%; margin-top: 10px;"></div>
                
                <!-- 凡例 -->
                <div class="mt-2 px-2">
                  <ul class="legend mb-0 small">
                    <li class="me-3"><i class="bi bi-circle-fill text-success" style="font-size: 8px;"></i> SMA(5)</li>
                    <li class="me-3"><i class="bi bi-circle-fill text-danger" style="font-size: 8px;"></i> SMA(25)</li>
                    <li class="me-3"><i class="bi bi-circle-fill text-primary" style="font-size: 8px;"></i> SMA(75)</li>
                    <li><i class="bi bi-circle-fill" style="color: purple; font-size: 8px;"></i> 乖離率(25)</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 📈 下段：基本統計情報 -->
      <div class="col-12">
        <div id="stockStats" class="card shadow-sm" style="display:none !important;"> <!-- JSでdisplay:flexになるのを防ぐためclass制御したいがJS依存なのでstyleは残す -->
          <div class="card-body">
            <div class="row">
              <div class="col-md-4 border-end">
                <h5 class="card-title mb-3 text-secondary border-bottom pb-2">
                  📈 基本統計 <i class="bi bi-question-circle text-muted help-icon" style="font-size: 0.85rem;" data-tooltip="※各情報は過去データに基づいて表示しているので，誤りを含む可能性があることに注意してください。"></i>
                </h5>
                <div class="row g-2 small">
                  <div class="col-6">時価総額: <b id="statCap">--</b></div>
                  <div class="col-6">利回り: <b id="statDiv">--</b></div>
                  <div class="col-6">PER: <b id="statPER">--</b></div>
                  <div class="col-6">PBR: <b id="statPBR">--</b></div>
                  <div class="col-6">ROE: <b id="statROE">--</b></div>
                  <div class="col-6">ROA: <b id="statROA">--</b></div>
                  <div class="col-6">配当性向: <b id="statPayout">--</b></div>
                  <div class="col-6">配当落ち日: <b id="statExDiv">--</b></div>
                </div>
                <div class="mt-3 pt-2 border-top small d-flex gap-3">
                  <span>最高値: <span id="statMax" class="fw-bold text-danger">-</span></span>
                  <span>最安値: <span id="statMin" class="fw-bold text-primary">-</span></span>
                </div>
              </div>
              <div class="col-md-8">
                <h5 class="card-title mb-3 text-primary border-bottom pb-2">🏢 AIによる会社説明</h5>
                <div id="companyInfoContent" class="small text-muted" style="min-height: 100px;">
                  銘柄を選択するとAIが会社概要を調査します...
                </div>
                <!-- 隠し要素 -->
                <ul id="statVolRanking" style="display: none;"></ul>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 🤖 AI分析セクション -->
      <div class="col-12 analysis-section">
        <div class="card shadow-sm">
          <div class="card-header bg-white p-0 border-bottom-0">
            <!-- 分析モード選択タブ -->
            <div class="analysis-tabs nav nav-tabs card-header-tabs m-0 px-3 pt-3 border-bottom-0" style="gap: 5px;">
              <button class="nav-link active tab-btn" data-mode="full" title="Google検索で最新の決算やニュースを調査"><i class="bi bi-search"></i> 個別株分析</button>
              <button class="nav-link tab-btn" data-mode="volume" title="出来高が急増した日の背景を調査"><i class="bi bi-bar-chart-fill"></i> 出来高分析</button>
              <button class="nav-link tab-btn" data-mode="tech" title="チャートの形から今後の展開を予測"><i class="bi bi-graph-up"></i> テクニカル分析</button>
              <button class="nav-link tab-btn" data-mode="market" title="最新ニュースから市場全体を分析"><i class="bi bi-globe"></i> 市況分析</button>
              <button class="nav-link tab-btn" data-mode="total" title="過去の分析結果を統合して多角的に分析"><i class="bi bi-gem"></i> 総合分析</button>
              <button class="nav-link tab-btn" data-mode="reresearch" title="既存の分析結果に対してさらに深掘り調査"><i class="bi bi-search-heart"></i> 再調査</button>
            </div>
          </div>

          <div class="card-body bg-light">
            <!-- 🌀 ローディング -->
            <div id="loading-container">
              <div class="loading-content">
                <div class="spinner-border text-primary" role="status" id="loading-spinner"></div>
                <div id="loading-indicator" class="fw-bold text-primary"></div>
                <!-- キャンセルボタン -->
                <button id="cancelAnalysisBtn" class="btn btn-outline-secondary btn-sm mt-3 px-4 rounded-pill">
                  <i class="bi bi-x-circle"></i> 分析をキャンセル
                </button>
              </div>
            </div>

            <!-- 分析結果出力 -->
            <div id="analysis-container" style="display: none;" class="bg-white p-4 rounded border mb-4">
              <div class="d-flex justify-content-end mb-3">
                <button id="exportPdfBtn" class="btn btn-danger rounded-pill px-5 py-2 shadow fw-bold" style="display: none; font-size: 1.1em; transition: transform 0.2s;">
                  <i class="bi bi-file-earmark-pdf-fill me-2"></i> PDF出力
                </button>
              </div>
              <div id="analysisResult" class="markdown-body"></div>
              
              <!-- トップへ戻るボタン -->
              <div class="text-center mt-4 border-top pt-3">
                <button id="scrollTopBtn" class="btn btn-light rounded-circle border shadow-sm" title="結果の先頭へ戻る" style="width: 45px; height: 45px;">
                    <i class="bi bi-arrow-up text-primary"></i>
                </button>
              </div>
            </div>

            <!-- 🕵️ 再調査フォーム -->
            <div id="reresearch-form-area" class="bg-white p-4 rounded border mb-4 shadow-sm" style="display: none;">
                <div class="row g-4">
                    <!-- ❶ AI深掘り調査 -->
                    <div class="col-md-6 border-end">
                        <h6 class="border-start border-4 border-info ps-2 mb-3 text-secondary">
                            ❶ AI深掘り調査 (矛盾・疑問点の洗い出し)
                            <i class="bi bi-question-circle text-muted help-icon" style="font-size: 0.85rem;" data-tooltip="【機能説明】
                            選択した過去のレポートをAIが読み込み、
                            情報の不足点や論理の矛盾点、
                            新たに生じた疑問点をAI自らが発見し、
                            Google検索で追加調査を行います。"></i>
                        </h6>
                        <p class="small text-muted mb-3">
                            下の「分析履歴」から対象のレポートを選択(チェック)してください。<br>
                            AIが自ら問いを立てて深掘りします。
                        </p>
                        <!-- オプション設定 -->
                        <div class="mt-3 pt-2 border-top">
                            <label class="form-label small fw-bold text-secondary">⚙️ オプション設定</label>
                            <div class="d-flex flex-wrap gap-2 small">
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" id="re_auto_beginner"> 初心者向け</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" id="re_auto_deep"> 詳細分析</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" id="re_auto_short"> 短期分析</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" id="re_auto_mid"> 中期分析</label>
                            </div>
                        </div>
                        <div class="text-center mt-4">
                            <button class="run-analysis-trigger btn btn-gradient-reresearch rounded-pill px-4" data-mode="reresearch_auto">
                                AI深掘り調査を実行 🚀
                            </button>
                        </div>
                    </div>
                    
                    <!-- ❷ ユーザー指定調査 -->
                    <div class="col-md-6">
                        <h6 class="border-start border-4 border-info ps-2 mb-3 text-secondary">
                            ❷ ユーザー指定調査 (疑問の解消)
                            <i class="bi bi-question-circle text-muted help-icon" style="font-size: 0.85rem;" data-tooltip="【機能説明】
                            選択したレポートの内容を踏まえた上で、
                            あなたが入力した具体的な質問に対して
                            Google検索を用いて回答します。"></i>
                        </h6>
                        <p class="small text-muted mb-2">
                            下の「分析履歴」から対象のレポートを選択し、
                            疑問点を入力してください。
                        </p>
                        <textarea id="user_question" class="form-control mb-3" rows="3" placeholder="例: この銘柄の競合他社は何？優位性は？"></textarea>
                        <!-- オプション設定 -->
                        <div class="mt-3 pt-2 border-top">
                            <label class="form-label small fw-bold text-secondary">⚙️ オプション設定</label>
                            <div class="d-flex flex-wrap gap-2 small">
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" id="re_manual_beginner"> 初心者向け</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" id="re_manual_deep"> 詳細分析</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" id="re_manual_fast"> ⚡高速モード</label>
                            </div>
                        </div>
                        <div class="text-center mt-4">
                            <button class="run-analysis-trigger btn btn-gradient-reresearch rounded-pill px-4" data-mode="reresearch_manual">
                                ユーザー指定調査を実行 🚀
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 🌍 市況分析フォーム -->
            <div id="market-form-area" class="bg-white p-4 rounded border mb-4 shadow-sm" style="display: none;">
              <div class="row g-4">
                <div class="col-md-6 col-lg-3">
                  <h6 class="border-start border-4 border-primary ps-2 mb-3 text-secondary">
                      📈 主要指標・全体市況
                      <i class="bi bi-question-circle text-muted help-icon" style="font-size: 0.85rem;" data-tooltip="【主要指標・全体市況の説明】
                      ・日経平均: 東証プライムの主要225銘柄の平均株価
                      ・グロース: 新興企業中心の市場。金利上昇局面に弱い
                      ・S&P500: 米国の主要企業500社の株価指数
                      ・NASDAQ: 米国のハイテク銘柄中心の指数
                      ・VIX指数: 通称恐怖指数。市場の不安が高まると上昇
                      ・ドル円: 米ドル円の為替レート。日本市場への影響大
                      ・国債利回り: 為替レートの最大の変動要因"></i>
                  </h6>
                  <div class="market-grid">
                    <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="日経平均"> 日経平均</label>
                    <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="グロース"> グロース</label>
                    <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="S&P500"> S&P500</label>
                    <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="NASDAQ"> NASDAQ</label>
                    <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="VIX"> VIX指数</label>
                    <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="ドル円"> ドル円</label>
                    <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="日本国債"> 日本国債</label>
                    <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="米国債"> 米国債</label>
                  </div>
                </div>
                <div class="col-md-6 col-lg-3">
                  <h6 class="border-start border-4 border-primary ps-2 mb-3 text-secondary">
                      🏦 マクロ経済
                      <i class="bi bi-question-circle text-muted help-icon" style="font-size: 0.85rem;" data-tooltip="【マクロ経済・金融政策の説明】
                      ・FRB: 米国の中央銀行。世界経済の舵取り役
                      ・FOMC: 米国の金融政策。その影響は世界に及ぶ
                      ・日銀: 日本の中央銀行。物価と通貨の安定を担う
                      ・利上げ/利下げ: 景気や物価を調整する金融政策の基本
                      ・米雇用統計: 金融政策及び世界の株価に直結するデータ
                      ・米CPI(米消費者物価指数): インフレ率を測る重要指標"></i>
                  </h6>
                  <div class="market-grid">
                    <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="FRB"> FRB</label>
                    <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="FOMC"> FOMC</label>
                    <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="日銀"> 日銀</label>
                    <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="利上げ"> 利上げ</label>
                    <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="利下げ"> 利下げ</label>
                    <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="米雇用統計"> 米雇用統計</label>
                    <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="CPI"> 米CPI</label>
                  </div>
                </div>
                <div class="col-md-6 col-lg-3">
                  <h6 class="border-start border-4 border-primary ps-2 mb-3 text-secondary">
                      🚀 主要セクター
                      <i class="bi bi-question-circle text-muted help-icon" style="font-size: 0.85rem;" data-tooltip="【注目のセクター・産業の説明】
                      ・半導体: あらゆるAIや機械の核となる産業
                      ・生成AI: 近年市場規模を急拡大。バブル懸念の噂も
                      ・データセンタ: AI・クラウドの影響で需要急増中
                      ・防衛: 近年の世界的なトレンド。防衛費が鍵
                      ・金: 安定資産。景気懸念や通貨価値下落局面で強い
                      ・原油: 経済活動の基本資源。物価や企業業績に直結
                      ・ビットコイン: 最もメジャーな暗号資産。値動きが激しめ"></i>
                  </h6>
                  <div class="market-grid">
                    <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="半導体"> 半導体</label>
                    <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="生成AI"> 生成AI</label>
                    <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="データセンタ"> データセンタ</label>
                    <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="防衛株"> 防衛</label>
                    <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="金価格"> 金</label>
                    <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="原油価格"> 原油</label>
                    <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="ビットコイン"> 暗号資産</label>
                  </div>
                </div>
                <div class="col-md-6 col-lg-3">
                  <h6 class="border-start border-4 border-primary ps-2 mb-3 text-secondary">
                      🌏 企業活動
                      <i class="bi bi-question-circle text-muted help-icon" style="font-size: 0.85rem;" data-tooltip="【企業活動・トレンドの説明】
                      ・決算発表: 企業の業績報告。株価変動の最大要因
                      ・上方/下方修正: 業績予想の修正。突然発表することも
                      ・株主還元: 株主に利益を還元する活動全般
                      ・増配: 配当を増やすこと。株価下支えの最大要因
                      ・自社株買い: 自社株を買うこと。買付数や期間も重要"></i>
                  </h6>
                  <div class="market-grid">
                    <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="決算発表"> 決算発表</label>
                    <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="上方修正"> 上方修正</label>
                    <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="下方修正"> 下方修正</label>
                    <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="株主還元"> 株主還元</label>
                    <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="増配"> 増配</label>
                    <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="自社株買い"> 自社株買い</label>
                  </div>
                </div>
              </div>
              
              <div class="mt-4 pt-3 border-top">
                <div class="row">
                  <div class="col-md-6">
                    <label class="form-label small fw-bold">
                        🔍 自由ワード検索
                        <i class="bi bi-question-circle text-muted help-icon" style="font-size: 0.85rem;" data-tooltip="【自由ワード検索の説明】
                        入力されたワードに従ってニュース調査を行ないます。
                        ニュースとして取り上げられにくいワードの場合
                        正常に分析結果が出力されない場合があります。"></i>
                    </label>
                    <input type="text" id="market_free_keyword" class="form-control mb-2" placeholder="例: 東京証券取引所">
                    
                    <details>
                        <summary class="small text-muted">📁 その他キーワード案（クリックで展開）</summary>
                        <div class="details-content mt-2 p-2 border rounded bg-light small">
                            <div class="d-flex flex-wrap gap-2">
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="円安"> 円安</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="円高"> 円高</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="IMM通貨"> IMM通貨</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="ユーロ"> ユーロ</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="ポンド"> ポンド</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="スイスフラン"> スイスフラン</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="新興国"> 新興国</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="日本政府"> 日本政府</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="米政府"> 米政府</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="植田総裁"> 植田総裁</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="パウエル議長"> パウエル議長</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="GDP"> GDP</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="景気後退"> 景気後退</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="人工知能"> 人工知能</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="銀行"> 銀行</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="量子"> 量子</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="自動車"> 自動車</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="原子力"> 原子力</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="インバウンド"> インバウンド</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="中国関連"> 中国関連</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="ハイテク関連"> ハイテク関連</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="情報通信"> 情報通信</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="小売"> 小売</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="商社"> 商社</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="ゲーム"> ゲーム</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="インフラ"> インフラ</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="建設"> 建設</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="TOB"> TOB</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="M&A"> M&A</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="IPO"> IPO</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="地政学リスク"> 地政学リスク</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="強気相場"> 強気相場</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="弱気相場"> 弱気相場</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="押し目"> 押し目</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="利益確定"> 利益確定</label>
                                <label class="form-check-label"><input type="checkbox" class="form-check-input" name="market_topic" value="踏み上げ"> 踏み上げ</label>
                            </div>
                        </div>
                    </details>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label small fw-bold">
                        ⚙️ オプション設定
                        <i class="bi bi-question-circle text-muted help-icon" style="font-size: 0.85rem;" data-tooltip="【オプション設定の説明】
                        ・詳細分析: リスク要因，市場心理，変動幅も分析
                        ・業種別分析: 各業種にフォーカスした分析
                        ・短期分析: 直近1週間に絞った分析
                        ・中期分析: 直近1ヶ月間に絞った分析
                        ・テクニカル分析: 移動平均線，トレンド，支持線，抵抗線，出来高について分析
                        ・初心者向け説明: 金融用語に※印の注釈を付与"></i>
                    </label>
                    <div class="d-flex flex-wrap gap-3 mt-2 small">
                      <label class="form-check-label"><input type="checkbox" class="form-check-input" id="m_deep"> 詳細分析</label>
                      <label class="form-check-label"><input type="checkbox" class="form-check-input" id="m_sector"> 業種別</label>
                      <label class="form-check-label"><input type="checkbox" class="form-check-input" id="m_short"> 短期</label>
                      <label class="form-check-label"><input type="checkbox" class="form-check-input" id="m_mid"> 中期</label>
                      <label class="form-check-label"><input type="checkbox" class="form-check-input" id="m_tech"> テクニカル</label>
                      <label class="form-check-label"><input type="checkbox" class="form-check-input" id="m_beginner"> 初心者向け</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 各分析モードの案内ウィンドウ -->
            <div id="full-analysis-guide" class="analysis-guide alert alert-light border-start border-4 border-primary shadow-sm">
              <h5 class="alert-heading text-primary"><i class="bi bi-search"></i> 個別株分析モード</h5>
              <p class="small text-muted mb-3">
                  最新の決算情報、株価動向、需給状況（信用倍率）、アナリスト評価などをGoogle検索を用いて多角的に調査・分析します。<br>
                  企業のファンダメンタルズに基づいた中長期的な分析に最適です。
              </p>
              <div class="mt-2 pt-2 border-top d-flex justify-content-between align-items-center">
                  <div class="d-flex flex-wrap gap-3 small">
                      <label class="form-check-label text-muted fw-bold"><input type="checkbox" class="form-check-input" id="full_beginner"> 初心者向け説明</label>
                      <label class="form-check-label text-muted fw-bold"><input type="checkbox" class="form-check-input" id="full_deep"> 詳細分析</label>
                      <label class="form-check-label text-muted fw-bold"><input type="checkbox" class="form-check-input" id="full_fast"> ⚡高速モード</label>
                  </div>
                  <button class="run-analysis-trigger btn btn-gradient-full rounded-pill px-4" data-mode="full">
                    個別株分析を実行する 🚀
                  </button>
              </div>
            </div>

            <div id="volume-analysis-guide" class="analysis-guide alert alert-light border-start border-4 border-primary shadow-sm" style="display:none;">
              <h5 class="alert-heading text-primary"><i class="bi bi-bar-chart-fill"></i> 出来高分析モード</h5>
              <p class="small text-muted mb-3">
                  過去1年間の出来高が多かった日について、その日に市場でどのようなイベントが発生したのかを調査します。<br>
                  株価が大きく動くきっかけとなった「材料」を掘り下げるのに役立ちます。
              </p>
              <div class="text-end">
                <button class="run-analysis-trigger btn btn-gradient-volume rounded-pill px-4" data-mode="volume">
                  出来高分析を実行する 🚀
                </button>
              </div>
            </div>

            <div id="tech-analysis-guide" class="analysis-guide alert alert-light border-start border-4 border-primary shadow-sm" style="display:none;">
              <h5 class="alert-heading text-primary"><i class="bi bi-graph-up"></i> テクニカル分析モード</h5>
              <p class="small text-muted mb-3">
                  直近1年間のチャートデータ（移動平均線、乖離率、支持線・抵抗線）に基づき、現在のトレンドと今後の展望をAIが分析します。<br>
                  需給分析や、テクニカルに基づいた売買タイミングの検討に最適です。
              </p>
              <div class="mt-2 pt-2 border-top d-flex justify-content-between align-items-center">
                  <div class="d-flex flex-wrap gap-3 small">
                      <label class="form-check-label text-muted fw-bold"><input type="checkbox" class="form-check-input" id="tech_beginner"> 初心者向け説明</label>
                      <label class="form-check-label text-muted fw-bold"><input type="checkbox" class="form-check-input" id="tech_deep"> 詳細分析</label>
                      <label class="form-check-label text-muted fw-bold"><input type="checkbox" class="form-check-input" id="tech_fast"> ⚡高速モード</label>
                  </div>
                  <button class="run-analysis-trigger btn btn-gradient-tech rounded-pill px-4" data-mode="tech">
                    テクニカル分析を実行する 🚀
                  </button>
              </div>
            </div>

            <div id="market-analysis-guide" class="analysis-guide alert alert-light border-start border-4 border-primary shadow-sm" style="display:none;">
              <h5 class="alert-heading text-primary"><i class="bi bi-globe"></i> 市況分析モード</h5>
              <p class="small text-muted mb-3">
                  主要な経済ニュースやキーワードを選択し、それらが株式市場全体や特定のセクターにどのような影響を与えているかを分析します。<br>
                  マクロ経済の動向や、現在の「相場のテーマ」を把握するのに役立ちます。<br><br>
                  ※キーワードを選択しすぎると、ニュースが適切に抽出できない場合があります。
              </p>
              <div class="text-end">
                <button class="run-analysis-trigger btn btn-gradient-market rounded-pill px-4" data-mode="market">
                  市況分析を実行する 🚀
                </button>
              </div>
            </div>

            <div id="total-analysis-guide" class="analysis-guide alert alert-light border-start border-4 border-primary shadow-sm" style="display:none;">
              <h5 class="alert-heading text-primary"><i class="bi bi-gem"></i> 総合分析モード</h5>
              <p class="small text-muted mb-3">
                  下の「分析履歴」から、統合して分析したい複数のレポートを選択して実行してください。<br>
                  異なる視点の情報をAIが整理・統合し、最終的な投資戦略を提案します。<br><br>
                  【オススメの使い方】<br>
                  ❶銘柄詳細を知るために各種分析レポートを選択して総合分析<br>
                  ❷同業他社の個別株分析レポートを複数選択して総合分析
              </p>
              <div class="text-end">
                <button class="run-analysis-trigger btn btn-gradient-total rounded-pill px-4" data-mode="total">
                  総合分析を実行する 🚀
                </button>
              </div>
            </div>

            <div id="reresearch-analysis-guide" class="analysis-guide alert alert-light border-start border-4 border-info shadow-sm" style="display:none;">
              <h5 class="alert-heading text-info"><i class="bi bi-search-heart"></i> 再調査・深掘りモード</h5>
              <p class="small text-muted mb-3">
                  既存のレポートに対して、さらなる追加調査を行います。<br>
                  AIが自律的に不足情報を補完する「AI自律調査」と、あなたの疑問に答える「ユーザー指定調査」の2つの機能があります。<br>
                  下のフォームから実行したい調査を選択してください。
              </p>
            </div>

          </div>
        </div>
      </div>

      <!-- 📜 分析履歴セクション -->
      <div class="col-12 mt-5">
        <h4 class="border-bottom pb-2 mb-3 text-secondary"><i class="bi bi-clock-history"></i> 分析履歴</h4>
        <div id="history-list" class="list-group list-group-flush">
          <!-- JSで履歴アイテムが追加される -->
          <p class="text-muted fst-italic p-3">まだ履歴はありません。</p>
        </div>
      </div>

    </div>
  </div>

  <!-- Footer -->
  <footer class="text-center text-muted py-4 mt-5 border-top small">
    &copy; 2026 Nikkei 225 Smart AI Analysis. Powered by Gemini & Flask.
  </footer>

  <!-- 📦 Python(Flask)から全銘柄データをJavaScriptへ受け渡し -->
  <script>
    const allStocks = JSON.parse('{{ stocks | tojson | safe }}');
  </script>
</body>
</html>
